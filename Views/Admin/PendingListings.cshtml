@model List<PrimeMarket.Models.Listing>
@{
    ViewData["Title"] = "Pending Listings";
    Layout = null;
    var userName = Context.Session.GetString("AdminUsername") ?? "Admin";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>@ViewData["Title"] - PrimeMarket Admin</title>
    <link rel="stylesheet" href="~/css/AdminDashboard.css" />
    <link rel="stylesheet" href="/css/notificationstyle.css" />
    <link rel="stylesheet" href="/css/messagenotifications.css" />
    <style>
        .listing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .listing-card {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

            .listing-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }

        .listing-image {
            height: 200px;
            overflow: hidden;
        }

            .listing-image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .listing-details {
            padding: 15px;
        }

        .listing-title {
            margin: 0 0 10px 0;
            font-size: 18px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .listing-price {
            color: #0066cc;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .listing-seller, .listing-category, .listing-date {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .listing-action {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-view, .btn-approve, .btn-reject {
            flex: 1;
            padding: 8px 0;
            background-color: #0066cc;
            color: white;
            border: none;
            border-radius: 5px;
            text-align: center;
            text-decoration: none;
            cursor: pointer;
        }

        .btn-approve {
            background-color: #28a745;
        }

        .btn-reject {
            background-color: #dc3545;
        }

        .btn-view:hover {
            background-color: #0055b3;
        }

        .btn-approve:hover {
            background-color: #218838;
        }

        .btn-reject:hover {
            background-color: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            background-color: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
        }

            .empty-state i {
                font-size: 50px;
                color: #ddd;
                margin-bottom: 20px;
            }

            .empty-state p {
                color: #666;
                font-size: 18px;
            }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .count-badge {
            background-color: #0066cc;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        .approval-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        textarea {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <a asp-action="AdminDashboard" asp-controller="Admin" class="logo">
                <img style="height: 50px; width: 100px; background-color: #f0f8ff" src="/images/PrimeMarket_Logo_V2.png" alt="PrimeMarket Logo" />
            </a>
            <div class="header-actions">
                <a asp-action="Logout" asp-controller="Admin"><button class="btn-logoutadmin">Logout</button></a>
                <p>@userName</p>

                <!-- Notification Bell -->
                <div class="notification-wrapper">
                    <img id="listingNotificationBell" class="notification-icon" style="margin-top:10px; height: 25px; width: 25px; cursor: pointer;" src="/images/NotificationBell.png" alt="Notification Bell" />
                    <div id="listingNotificationDropdown" class="notification-dropdown">
                        <p class="notification-item">An item is waiting to be approved or rejected</p>
                        <p class="notification-item">A user sent ID for verification.</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="dashboard">
        <div class="sidebar">
            <ul>
                <li onclick="window.location.href='@Url.Action("PendingVerifications", "Admin")'" class="nav-item">User ID Verifications</li>
                <li onclick="window.location.href='@Url.Action("PendingListings", "Admin")'" class="nav-item active">Pending Listings</li>
                <li onclick="window.location.href='@Url.Action("UsageReport", "Admin")'" class="nav-item">Usage Report</li>
            </ul>
        </div>

        <div class="dashboard-content">
            <div class="section-header">
                <h1>Pending Listings <span class="count-badge">@Model.Count</span></h1>
            </div>

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success">
                    @TempData["SuccessMessage"]
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger">
                    @TempData["ErrorMessage"]
                </div>
            }

            @if (Model == null || Model.Count == 0)
            {
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <p>No pending listings to review!</p>
                </div>
            }
            else
            {
                <div class="listing-grid">
                    @foreach (var listing in Model)
                    {
                        var mainImage = listing.Images != null && listing.Images.Any()
                        ? (listing.Images.FirstOrDefault(i => i.IsMainImage)?.ImagePath ?? listing.Images.First().ImagePath)
                        : "/images/placeholder.png";

                        <div class="listing-card" data-id="@listing.Id">
                            <a href="@Url.Action("ListingDetails", "Admin", new { id = listing.Id })">
                                <div class="listing-image">
                                    <img src="@mainImage" alt="@listing.Title">
                                </div>
                                <div class="listing-details">
                                    <h3 class="listing-title">@listing.Title</h3>
                                    <p class="listing-price">@listing.Price.ToString("C")</p>
                                    <p class="listing-seller">Seller: @(listing.Seller?.FirstName ?? "") @(listing.Seller?.LastName ?? "")</p>
                                    <p class="listing-category">Category: @listing.Category > @listing.SubCategory</p>
                                    <p class="listing-date">Listed: @(((DateTime)listing.CreatedAt).ToString("MMM dd, yyyy"))</p>
                                </div>
                            </a>
                            <div class="listing-action">
                                <button onclick="openListingActions('@listing.Id')" class="btn-view">Review</button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Modal for listing actions -->
    <div id="listingActionsModal" class="modal">
        <div class="modal-content" style="max-width: 800px; width: 90%;">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Review Listing</h2>

            <!-- Listing details section -->
            <div class="listing-review-details" style="display: flex; margin: 20px 0; border-bottom: 1px solid #ddd; padding-bottom: 20px;">
                <div id="modalListingImage" style="width: 200px; height: 200px; border-radius: 8px; overflow: hidden; margin-right: 20px; flex-shrink: 0;">
                    <img src="" alt="Listing Image" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <div style="flex: 1;">
                    <h3 id="modalListingTitle" style="margin-top: 0; margin-bottom: 10px;"></h3>
                    <p id="modalListingPrice" style="font-weight: bold; color: #0066cc; font-size: 18px; margin-bottom: 10px;"></p>
                    <p id="modalListingSeller" style="margin-bottom: 5px;"></p>
                    <p id="modalListingCategory" style="margin-bottom: 5px;"></p>
                    <p id="modalListingDate" style="margin-bottom: 5px;"></p>
                    <p id="modalListingDescription" style="margin-top: 15px; max-height: 150px; overflow-y: auto;"></p>
                </div>
            </div>

            <p>Would you like to approve or reject this listing?</p>

            <div class="approval-actions">
                <form id="approveForm" method="post" asp-action="ApproveListing" asp-controller="Admin">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="approveListingId" name="id" value="">
                    <button type="submit" class="btn-approve">Approve</button>
                </form>

                <button class="btn-reject" onclick="showRejectForm()">Reject</button>

                <!-- View Details link -->
                <a id="viewDetailsLink" href="#" style="flex: 1; display: flex; justify-content: center; align-items: center; text-decoration: none;">
                    <button style="width: 100%; background-color: #0066cc;" class="btn-view">View Full Details</button>
                </a>
            </div>

            <div id="rejectForm" style="display: none; margin-top: 15px;">
                <form method="post" asp-action="RejectListing" asp-controller="Admin">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="rejectListingId" name="id" value="">
                    <label for="rejectionReason">Rejection Reason:</label>
                    <textarea id="rejectionReason" name="rejectionReason" required></textarea>
                    <div style="text-align: right; margin-top: 10px;">
                        <button type="submit" class="btn-reject">Confirm Rejection</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentListingId = null;

        // Function to open listing actions modal
        function openListingActions(listingId) {
            currentListingId = listingId;

            // Set the listing ID in the forms
            document.getElementById('approveListingId').value = listingId;
            document.getElementById('rejectListingId').value = listingId;

            // Get listing details from the card
            const listingCard = document.querySelector(`.listing-card[data-id="${listingId}"]`);
            const imageElement = listingCard.querySelector('.listing-image img');
            const titleElement = listingCard.querySelector('.listing-title');
            const priceElement = listingCard.querySelector('.listing-price');
            const sellerElement = listingCard.querySelector('.listing-seller');
            const categoryElement = listingCard.querySelector('.listing-category');
            const dateElement = listingCard.querySelector('.listing-date');

            // Populate the modal with listing details
            document.getElementById('modalListingImage').querySelector('img').src = imageElement.src;
            document.getElementById('modalListingTitle').textContent = titleElement.textContent;
            document.getElementById('modalListingPrice').textContent = priceElement.textContent;
            document.getElementById('modalListingSeller').textContent = sellerElement.textContent;
            document.getElementById('modalListingCategory').textContent = categoryElement.textContent;
            document.getElementById('modalListingDate').textContent = dateElement.textContent;

            // Set the "View Full Details" link
            document.getElementById('viewDetailsLink').href = `/Admin/ListingDetails/${listingId}`;

            // Use AJAX to get the listing description (optional, if not shown in the listing card)
            fetch(`/Admin/GetListingDescription/${listingId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('modalListingDescription').textContent = data.description;
                    }
                })
                .catch(err => {
                    console.error('Error fetching listing description:', err);
                    document.getElementById('modalListingDescription').textContent = 'Click "View Full Details" to see the complete listing information.';
                });

            // Show the modal
            document.getElementById('listingActionsModal').style.display = 'block';

            // Hide reject form initially
            document.getElementById('rejectForm').style.display = 'none';
        }

        // Function to close the modal
        function closeModal() {
            document.getElementById('listingActionsModal').style.display = 'none';
        }

        // Function to show the reject form
        function showRejectForm() {
            document.getElementById('rejectForm').style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Toggle notification dropdown
            const notificationBell = document.getElementById('listingNotificationBell');
            const notificationDropdown = document.getElementById('listingNotificationDropdown');

            if (notificationBell && notificationDropdown) {
                notificationBell.addEventListener('click', function(e) {
                    e.stopPropagation();
                    notificationDropdown.style.display = notificationDropdown.style.display === 'block' ? 'none' : 'block';
                });

                document.addEventListener('click', function(event) {
                    if (!notificationDropdown.contains(event.target) && event.target !== notificationBell) {
                        notificationDropdown.style.display = 'none';
                    }
                });
            }

            // Close modal when clicking outside
            window.onclick = function(event) {
                if (event.target == document.getElementById('listingActionsModal')) {
                    closeModal();
                }
            }
        });
    </script>
</body>
</html>